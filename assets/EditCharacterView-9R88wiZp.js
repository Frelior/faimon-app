import{e as Q,l as G,f as X,m as x,k as b,y as Y,c as o,F as T,h as p,a as t,q as B,u as w,t as C,i as R,r as Z,b as L,d as v,w as K,N as ee,O as H,P as F,I as j,Q as N,S as D,o as i,_ as W,p as te,A as _,U as S,E as U,V as le,W as ae}from"./index-D4KDGZp8.js";import{I as ne,s as A,c as se,C as ie,g as oe,a as re}from"./CharacterPageView-BQBxAk0d.js";import{C as q}from"./CharacterHexagonComponent-CC-s8UNm.js";import{P as ue}from"./overlayscrollbars-vue-BLAM1IrN.js";const ce={key:0,id:"view-head",class:"edit-skills"},de={class:"btns"},pe=["disabled"],ve={class:"block-title"},fe={class:"skills"},me={key:0,class:"skill-title"},he={class:"block-skill inner"},ge={key:0,class:"l-name"},_e=["innerHTML","onClick"],be=["innerHTML","onClick"],Ce=["onClick"],we={class:"block-skill-buttons"},ke={key:0},Ie={key:1},ye={key:0},Ue={key:1},Ve=["src"],$e=["onChange"],Ee=["onClick"],Se=["onClick"],xe=["onClick"],Te=["disabled"],Oe=Q({__name:"EditCharacterSkillsView",setup(z){const u=G(),r=X({attack:{title:"Базовая атака",skills:[]},special:{title:"Специальная Атака",skills:[]},technique:{title:"Техника",skills:[]},ultimate:{title:"Ульта",skills:[]},tactic:{title:"Тактик умение",skills:[]},counter:{title:"Контратака",skills:[]},dodge:{title:"Уклонение",skills:[]},passive:{title:"Пассивки",skills:[]},constellation:{title:"Консты",skills:[]},weapon:{title:"Оружие",skills:[]},coreStamp:{title:"Именной штамп",skills:[]},description:{title:"Описание",skills:[]}}),k=x(()=>Object.values(r).flatMap(e=>e.skills)),a=b([]),V=b([]),y=b([]),d=b(!1),I=b(0);Y(()=>u.currentCharacter,async()=>{if(u.currentCharacter){const e=await oe(u.currentCharacter.id);if(e)for(const l in r)r[l].skills=re(e,l)}},{immediate:!0});function $(e,l){e.id&&a.value.push(e.id),l.splice(l.indexOf(e),1),console.log(a.value)}function E(e,l,g){if(!l||!g)return;const c=e.target;if(!c.files||!c.files[0])return;const s=c.files[0],n=H(g,s.name);console.log("new image path",n),y.value.push({file:s,path:n}),console.log(y.value),l.image_path&&V.value.push(l.image_path),l.image_path=n,l.preview_url=F(s,l?.preview_url)}function M(e){e.image_path&&V.value.push(e.image_path),e.image_path="",e.preview_url=""}async function O(){if(!window.confirm("Вы уверены, что хотите сохранить изменения скилов?"))return;let l=!1;if(d.value=!0,!k.value.length){d.value=!1,alert("НЕТ СКИЛОВ");return}k.value.forEach(s=>{Object.keys(s).includes("preview_url")&&delete s.preview_url,Object.keys(s).includes("client_id")&&delete s.client_id});const g=k.value.filter(s=>s.id),c=k.value.filter(s=>!s.id);for(const s of g){const{id:n,...h}=s,{error:J}=await j.from("skills").update(h).eq("id",n);J&&(d.value=!1,alert("Ошибка обновления скилов"),l=!0)}for(const s of c){const{error:n}=await j.from("skills").insert(s);n&&(d.value=!1,alert("Ошибка добавления скилов"),l=!0)}a.value.length&&await j.from("skills").delete().in("id",a.value).then(s=>{console.log(s.data),s.error&&(console.error(s.error),alert("Ошибка удаления скилов, но все остальные скилы обновлены"),l=!0),a.value=[]});for(const s of V.value)await N(s);for(const s of y.value)await D(s.path,s.file);l&&(d.value=!1,alert("Сохранение прошло с ошибками")),alert("Информация персонажа обновлена, перезагрузите страницу"),d.value=!1}const f=b(null);function P(e,l){f.value={skillId:e.client_id,field:l}}function m(){f.value=null}return(e,l)=>{const g=Z("QuillEditor");return i(),o(T,null,[w(u).currentCharacter?.id?(i(),o("div",ce,[l[3]||(l[3]=t("h1",null,"Редактирование скилов (нажми на поле для редактирования)",-1)),t("div",de,[t("button",{disabled:d.value,class:"save-skills save-btn",onClick:O},C(d.value?"Сохранение...":"СОХРАНИТЬ СКИЛЛЫ"),9,pe)]),(i(!0),o(T,null,R(r,(c,s)=>(i(),o("div",{class:"info-block",key:s},[t("p",ve,C(c.title),1),t("div",fe,[(i(!0),o(T,null,R(c.skills,n=>(i(),o("div",{class:"block-skill",key:n.client_id},[s!=="description"?(i(),o("p",me," Запись №"+C(c.skills.indexOf(n)+1),1)):p("",!0),t("div",he,[s!=="description"?(i(),o("p",ge,"Название")):p("",!0),s!=="description"&&!(f.value?.skillId===n.client_id&&f.value?.field==="name")?(i(),o("div",{key:1,class:"editable-text",innerHTML:n.name||"<i>Кликните для редактирования</i>",onClick:h=>P(n,"name")},null,8,_e)):p("",!0),s!=="description"&&f.value?.skillId===n.client_id&&f.value?.field==="name"?(i(),B(g,{key:2,theme:"snow","content-type":"html",toolbar:"full",content:n.name,"onUpdate:content":h=>n.name=h,onBlur:m},null,8,["content","onUpdate:content"])):p("",!0),l[1]||(l[1]=t("p",{class:"l-name"},"Описание",-1)),f.value?.skillId===n.client_id&&f.value?.field==="description"?p("",!0):(i(),o("div",{key:3,class:"editable-text",innerHTML:n.description||"<i>Кликните для редактирования</i>",onClick:h=>P(n,"description")},null,8,be)),f.value?.skillId===n.client_id&&f.value?.field==="description"?(i(),B(g,{key:4,theme:"snow","content-type":"html",toolbar:"full",content:n.description,"onUpdate:content":h=>n.description=h,onBlur:m},null,8,["content","onUpdate:content"])):p("",!0),t("button",{class:"small-btn",onClick:h=>{n.name="",n.description=""}}," Отчистить текст ",8,Ce)]),t("div",we,[t("p",null,[l[2]||(l[2]=v(" Картинка: ",-1)),s==="description"?(i(),o("span",ke,"Баннер в начале страницы, в оригинале 1600х1016 .webp")):(i(),o("span",Ie,"соотношение 1:1, лучше всего 256х256 .webp, без отступов от краев"))]),n.image_path?(i(),o("p",ye,"Загружена: "+C(n.image_path),1)):(i(),o("p",Ue,"Отсутствует")),L(ne,null,{default:K(()=>[n.image_path||n.preview_url?(i(),o("img",{key:0,src:n.preview_url||w(ee)(n.image_path)||"",class:"block-skill-image"},null,8,Ve)):p("",!0)]),_:2},1024),t("input",{type:"file",accept:"image/*",onChange:h=>E(h,n,"skillIcons"),multiple:"false"},null,40,$e),n.image_path?(i(),o("button",{key:2,class:"small-btn del-btn",onClick:h=>M(n)}," Удалить картинку с сервера ",8,Ee)):p("",!0),t("button",{class:"skill-del-btn del-btn",onClick:h=>($(n,c.skills),c.skills=w(A)(c.skills))}," УДАЛИТЬ СКИЛЛ ",8,Se)])]))),128)),s==="description"&&c.skills.length>=1?p("",!0):(i(),o("button",{key:0,class:"add-btn",onClick:n=>(c.skills.push(w(se)(w(u).currentCharacter.id,String(s),c.skills.length+1)),c.skills=w(A)(c.skills))}," ДОБАВИТЬ СКИЛЛ В СЕКЦИЮ ",8,xe))])]))),128))])):p("",!0),t("button",{disabled:d.value,class:"save-skills save-btn",onClick:O},C(d.value?"Сохранение...":"СОХРАНИТЬ СКИЛЛЫ"),9,Te),l[4]||(l[4]=t("p",{class:"preview-title"},"ПРЕВЬЮ",-1)),t("button",{onClick:l[0]||(l[0]=c=>I.value++)},"Обновить превью"),k.value.length&&w(u).currentCharacter?(i(),B(ie,{id:"view-preview",key:I.value,previewCharacter:w(u).currentCharacter,previewSkills:k.value},null,8,["previewCharacter","previewSkills"])):p("",!0)],64)}}}),Pe=W(Oe,[["__scopeId","data-v-6919b530"]]),Be={key:0,class:"view-container edit-character"},Le={class:"wrapper"},Re={class:"character-info"},Me={class:"header"},je={class:"selected"},He=["value"],Fe={class:"preview-icons"},Ne={class:"current-info"},De={class:"debug-info"},Ae={class:"object-ifno"},qe={class:"info-fields"},Qe={class:"info-fields"},Ge={class:"info-fields"},Ke={class:"btns"},We=["disabled"],ze={key:0},Je=["disabled"],Xe=Q({__name:"EditCharacterView",setup(z){const u=b(!1),r=G(),k=x(()=>r.characters),a=x(()=>r.currentCharacter),V=x(()=>a.value?Object.keys(a.value):[]),y=x({get:()=>r.currentCharacterId,set:m=>{m!==null&&r.changeCurrentCharacterId(m)}}),d=b(null),I=b(null),$=b(null),E=b(null);function M(m){const e=m.target;if(!e.files||!e.files[0])return;d.value=e.files[0],console.log(d.value),r.editViewCharacterIconUrl=F(d.value,r.editViewCharacterIconUrl),console.log(r.editViewCharacterIconUrl);const l=H("characterIcons",d.value.name);$.value=a.value.icon_path,a.value.icon_path=l}function O(m){const e=m.target;if(!e.files||!e.files[0])return;I.value=e.files[0],console.log(I.value),r.editViewCharacterImageUrl=F(I.value,r.editViewCharacterImageUrl),console.log(r.editViewCharacterIconUrl);const l=H("characterFull",I.value.name);E.value=a.value.image_full_path,a.value.image_full_path=l}async function f(){if(u.value=!0,!window.confirm("Вы уверены, что хотите обновить персонажа?"))return;const e=a.value;if(!e.name){alert("НЕТ ИМЕНИ ПЕРСОНАЖА"),u.value=!1;return}console.log("UPLOADINBG CHARACTER: ",e);let l=!1;if(!e.icon_path||!e.image_full_path){alert("НЕТ ИЗОБРАЖЕНИЙ ПЕРСОНАЖА"),u.value=!1;return}e.icon_path&&($.value&&await N($.value).catch(g=>console.log(g)),await D(e.icon_path,d.value).catch(()=>l=!0)),e.image_full_path&&(E.value&&await N(E.value).catch(g=>console.log(g)),await D(e.image_full_path,I.value).catch(()=>l=!0)),await le(e),u.value=!1,r.editViewCharacterIconUrl="",r.editViewCharacterImageUrl="",l&&alert("Ошибка при загрузке изображений"),alert("Информация персонажа обновлена, перезагрузите страницу"),r.changeCurrentCharacterId(e.id)}async function P(){if(u.value=!0,!window.confirm("Вы уверены, что хотите удалить персонажа?")){u.value=!1;return}await ae(a.value),u.value=!1}return te(()=>{r.editViewCharacterIconUrl&&URL.revokeObjectURL(r.editViewCharacterIconUrl),r.editViewCharacterImageUrl&&URL.revokeObjectURL(r.editViewCharacterImageUrl)}),(m,e)=>a.value?(i(),o("div",Be,[L(w(ue),{class:"scrollbar-root",options:{scrollbars:{autoHide:"never",theme:"os-theme-light"}}},{default:K(()=>[t("div",Le,[t("div",Re,[t("div",Me,[t("div",je,[t("p",null,"Выбрано: "+C(a.value.name),1),_(t("select",{"onUpdate:modelValue":e[0]||(e[0]=l=>y.value=l)},[(i(!0),o(T,null,R(k.value,l=>(i(),o("option",{key:l.id,value:l.id},C(l.name),9,He))),128)),e[11]||(e[11]=t("option",{value:-1},"Новый",-1))],512),[[S,y.value]])]),t("div",Fe,[L(q,{character:a.value},null,8,["character"]),L(q,{character:a.value,squared:""},null,8,["character"])])]),t("div",Ne,[t("div",De,[(i(!0),o(T,null,R(V.value,l=>(i(),o("div",{key:l},C(l)+": "+C(a.value[l]),1))),128))]),t("div",Ae,[t("div",qe,[t("label",null,[e[12]||(e[12]=v("Имя ",-1)),_(t("input",{type:"text","onUpdate:modelValue":e[1]||(e[1]=l=>a.value.name=l)},null,512),[[U,a.value.name]])]),t("label",null,[e[14]||(e[14]=v("Редкость ",-1)),_(t("select",{"onUpdate:modelValue":e[2]||(e[2]=l=>a.value.rarity=l)},[...e[13]||(e[13]=[t("option",{value:"sr"},"sr",-1),t("option",{value:"ssr"},"ssr",-1)])],512),[[S,a.value.rarity]])]),t("label",null,[e[16]||(e[16]=v("Роль ",-1)),_(t("select",{"onUpdate:modelValue":e[3]||(e[3]=l=>a.value.role=l)},[...e[15]||(e[15]=[t("option",{value:"assault"},"assault",-1),t("option",{value:"support"},"support",-1),t("option",{value:"tactic"},"tactic",-1)])],512),[[S,a.value.role]])]),t("label",null,[e[18]||(e[18]=v("Тип урона ",-1)),_(t("select",{"onUpdate:modelValue":e[4]||(e[4]=l=>a.value.type=l)},[...e[17]||(e[17]=[t("option",{value:"slash"},"slash",-1),t("option",{value:"strike"},"strike",-1),t("option",{value:"thrust"},"thrust",-1),t("option",{value:"spirit"},"spirit",-1)])],512),[[S,a.value.type]])]),t("label",null,[e[20]||(e[20]=v("Тир ",-1)),_(t("select",{"onUpdate:modelValue":e[5]||(e[5]=l=>a.value.tier=l)},[...e[19]||(e[19]=[t("option",{value:"s"},"s",-1),t("option",{value:"a"},"a",-1),t("option",{value:"b"},"b",-1),t("option",{value:"c"},"c",-1),t("option",{value:"d"},"d",-1)])],512),[[S,a.value.tier]])])]),t("div",Qe,[t("label",null,[e[21]||(e[21]=v("АТК ",-1)),_(t("input",{type:"number","onUpdate:modelValue":e[6]||(e[6]=l=>a.value.attack=l)},null,512),[[U,a.value.attack]])]),t("label",null,[e[22]||(e[22]=v("DEF ",-1)),_(t("input",{type:"number","onUpdate:modelValue":e[7]||(e[7]=l=>a.value.defence=l)},null,512),[[U,a.value.defence]])]),t("label",null,[e[23]||(e[23]=v("HP ",-1)),_(t("input",{type:"number","onUpdate:modelValue":e[8]||(e[8]=l=>a.value.hp=l)},null,512),[[U,a.value.hp]])]),t("label",null,[e[24]||(e[24]=v("CRIT DMG % ",-1)),_(t("input",{type:"number","onUpdate:modelValue":e[9]||(e[9]=l=>a.value.crit_damage=l)},null,512),[[U,a.value.crit_damage]])]),t("label",null,[e[25]||(e[25]=v("CRIT RATE % ",-1)),_(t("input",{type:"number","onUpdate:modelValue":e[10]||(e[10]=l=>a.value.crit_rate=l)},null,512),[[U,a.value.crit_rate]])])]),t("div",Ge,[t("label",null,[e[26]||(e[26]=v("Иконка 136х160 .webp ",-1)),t("input",{type:"file",accept:"image/webp",onChange:M,multiple:"false"},null,32)]),t("label",null,[e[27]||(e[27]=v("1920х1080 арт персонажа .webp ",-1)),t("input",{type:"file",accept:"image/webp",onChange:O,multiple:"false"},null,32)]),e[28]||(e[28]=t("p",null," Для любых картинок / иконок лучше всего использовать формат .webp - он почти такой же по качесвту как png, но обычно весит в 2-3 раза меньше, что влияет на скорость загрузки страницы. Однако можно загружать и другие форматы, они просто весят больше. ",-1))])])]),t("div",Ke,[t("button",{disabled:u.value,class:"save-btn",onClick:f},C(u.value?"в процессе...":"СОХРАНИТЬ ПЕРСОНАЖА"),9,We),u.value?(i(),o("p",ze,"загрузочка...")):p("",!0),t("button",{disabled:u.value,class:"del-btn",onClick:P},C(u.value?"в процессе...":"УДАЛИТЬ ПЕРСОНАЖА"),9,Je)])]),y.value>0?(i(),B(Pe,{key:0})):p("",!0)])]),_:1})])):p("",!0)}}),lt=W(Xe,[["__scopeId","data-v-fa74fb4d"]]);export{lt as default};
