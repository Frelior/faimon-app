import{e as A,l as G,f as Z,m as T,k as _,x as K,c as u,F as O,h as v,a as t,q as B,u as k,t as C,i as M,r as W,b as S,d as f,w as X,N as ee,O as j,Q as N,I as H,S as F,U as Q,o,_ as z,p as te,P as le,A as b,V as x,E as U,W as ae,X as ne}from"./index-Umatlif-.js";import{I as se,s as q,c as ie,C as oe,g as re,a as ue}from"./CharacterPageView-zWoO5Qc6.js";import{C as D}from"./CharacterHexagonComponent-VZ6cFJVA.js";const de={key:0,id:"view-head",class:"edit-skills"},ce={class:"btns"},pe=["disabled"],ve={class:"block-title"},fe={class:"skills"},me={key:0,class:"skill-title"},he={class:"block-skill inner"},ge={key:0,class:"l-name"},_e=["innerHTML","onClick"],be=["innerHTML","onClick"],Ce=["onClick"],ke={class:"block-skill-buttons"},we={key:0},Ie={key:1},ye={key:0},Ue={key:1},Ve=["src"],$e=["onChange"],Ee=["onClick"],xe=["onClick"],Te=["onClick"],Se=["disabled"],Oe=A({__name:"EditCharacterSkillsView",setup(J){const m=G(),c=Z({attack:{title:"Базовая атака",skills:[]},special:{title:"Специальная Атака",skills:[]},technique:{title:"Техника",skills:[]},ultimate:{title:"Ульта",skills:[]},tactic:{title:"Тактик умение",skills:[]},counter:{title:"Контратака",skills:[]},dodge:{title:"Уклонение",skills:[]},passive:{title:"Пассивки",skills:[]},constellation:{title:"Консты",skills:[]},weapon:{title:"Оружие",skills:[]},coreStamp:{title:"Именной штамп",skills:[]},description:{title:"Описание",skills:[]}}),r=T(()=>Object.values(c).flatMap(d=>d.skills)),I=_([]),n=_([]),V=_([]),p=_(!1),w=_(0);K(()=>m.currentCharacter,async()=>{if(m.currentCharacter){const d=await re(m.currentCharacter.id);if(d)for(const a in c)c[a].skills=ue(d,a)}},{immediate:!0});function y(d,a){d.id&&I.value.push(d.id),a.splice(a.indexOf(d),1),console.log(I.value)}function $(d,a,e){if(!a||!e)return;const i=d.target;if(!i.files||!i.files[0])return;const l=i.files[0],s=j(e,l.name);console.log("new image path",s),V.value.push({file:l,path:s}),console.log(V.value),a.image_path&&n.value.push(a.image_path),a.image_path=s,a.preview_url=N(l,a?.preview_url)}function E(d){d.image_path&&n.value.push(d.image_path),d.image_path="",d.preview_url=""}async function R(){if(!window.confirm("Вы уверены, что хотите сохранить изменения скилов?"))return;let a=!1;if(p.value=!0,!r.value.length){p.value=!1,alert("НЕТ СКИЛОВ");return}r.value.forEach(l=>{Object.keys(l).includes("preview_url")&&delete l.preview_url,Object.keys(l).includes("client_id")&&delete l.client_id});const e=r.value.filter(l=>l.id),i=r.value.filter(l=>!l.id);for(const l of e){const{id:s,...g}=l,{error:Y}=await H.from("skills").update(g).eq("id",s);Y&&(p.value=!1,alert("Ошибка обновления скилов"),a=!0)}for(const l of i){const{error:s}=await H.from("skills").insert(l);s&&(p.value=!1,alert("Ошибка добавления скилов"),a=!0)}I.value.length&&await H.from("skills").delete().in("id",I.value).then(l=>{console.log(l.data),l.error&&(console.error(l.error),alert("Ошибка удаления скилов, но все остальные скилы обновлены"),a=!0),I.value=[]});for(const l of n.value)await F(l);for(const l of V.value)await Q(l.path,l.file);a&&(p.value=!1,alert("Сохранение прошло с ошибками")),alert("Информация персонажа обновлена, перезагрузите страницу"),p.value=!1}const h=_(null);function L(d,a){h.value={skillId:d.client_id,field:a}}function P(){h.value=null}return(d,a)=>{const e=W("QuillEditor");return o(),u(O,null,[k(m).currentCharacter?.id?(o(),u("div",de,[a[3]||(a[3]=t("h1",null,"Редактирование скилов (нажми на поле для редактирования)",-1)),t("div",ce,[t("button",{disabled:p.value,class:"save-skills save-btn",onClick:R},C(p.value?"Сохранение...":"СОХРАНИТЬ СКИЛЛЫ"),9,pe)]),(o(!0),u(O,null,M(c,(i,l)=>(o(),u("div",{class:"info-block",key:l},[t("p",ve,C(i.title),1),t("div",fe,[(o(!0),u(O,null,M(i.skills,s=>(o(),u("div",{class:"block-skill",key:s.client_id},[l!=="description"?(o(),u("p",me," Запись №"+C(i.skills.indexOf(s)+1),1)):v("",!0),t("div",he,[l!=="description"?(o(),u("p",ge,"Название")):v("",!0),l!=="description"&&!(h.value?.skillId===s.client_id&&h.value?.field==="name")?(o(),u("div",{key:1,class:"editable-text",innerHTML:s.name||"<i>Кликните для редактирования</i>",onClick:g=>L(s,"name")},null,8,_e)):v("",!0),l!=="description"&&h.value?.skillId===s.client_id&&h.value?.field==="name"?(o(),B(e,{key:2,theme:"snow","content-type":"html",toolbar:"full",content:s.name,"onUpdate:content":g=>s.name=g,onBlur:P},null,8,["content","onUpdate:content"])):v("",!0),a[1]||(a[1]=t("p",{class:"l-name"},"Описание",-1)),h.value?.skillId===s.client_id&&h.value?.field==="description"?v("",!0):(o(),u("div",{key:3,class:"editable-text",innerHTML:s.description||"<i>Кликните для редактирования</i>",onClick:g=>L(s,"description")},null,8,be)),h.value?.skillId===s.client_id&&h.value?.field==="description"?(o(),B(e,{key:4,theme:"snow","content-type":"html",toolbar:"full",content:s.description,"onUpdate:content":g=>s.description=g,onBlur:P},null,8,["content","onUpdate:content"])):v("",!0),t("button",{class:"small-btn",onClick:g=>{s.name="",s.description=""}}," Отчистить текст ",8,Ce)]),t("div",ke,[t("p",null,[a[2]||(a[2]=f(" Картинка: ",-1)),l==="description"?(o(),u("span",we,"Баннер в начале страницы, в оригинале 1600х1016 .webp")):(o(),u("span",Ie,"соотношение 1:1, лучше всего 256х256 .webp, без отступов от краев"))]),s.image_path?(o(),u("p",ye,"Загружена: "+C(s.image_path),1)):(o(),u("p",Ue,"Отсутствует")),S(se,null,{default:X(()=>[s.image_path||s.preview_url?(o(),u("img",{key:0,src:s.preview_url||k(ee)(s.image_path)||"",class:"block-skill-image"},null,8,Ve)):v("",!0)]),_:2},1024),t("input",{type:"file",accept:"image/*",onChange:g=>$(g,s,"skillIcons"),multiple:"false"},null,40,$e),s.image_path?(o(),u("button",{key:2,class:"small-btn del-btn",onClick:g=>E(s)}," Удалить картинку с сервера ",8,Ee)):v("",!0),t("button",{class:"skill-del-btn del-btn",onClick:g=>(y(s,i.skills),i.skills=k(q)(i.skills))}," УДАЛИТЬ СКИЛЛ ",8,xe)])]))),128)),l==="description"&&i.skills.length>=1?v("",!0):(o(),u("button",{key:0,class:"add-btn",onClick:s=>(i.skills.push(k(ie)(k(m).currentCharacter.id,String(l),i.skills.length+1)),i.skills=k(q)(i.skills))}," ДОБАВИТЬ СКИЛЛ В СЕКЦИЮ ",8,Te))])]))),128))])):v("",!0),t("button",{disabled:p.value,class:"save-skills save-btn",onClick:R},C(p.value?"Сохранение...":"СОХРАНИТЬ СКИЛЛЫ"),9,Se),a[4]||(a[4]=t("p",{class:"preview-title"},"ПРЕВЬЮ",-1)),t("button",{onClick:a[0]||(a[0]=i=>w.value++)},"Обновить превью"),r.value.length&&k(m).currentCharacter?(o(),B(oe,{id:"view-preview",key:w.value,previewCharacter:k(m).currentCharacter,previewSkills:r.value},null,8,["previewCharacter","previewSkills"])):v("",!0)],64)}}}),Re=z(Oe,[["__scopeId","data-v-6919b530"]]),Le={key:0,class:"view-container edit-character"},Pe={class:"wrapper"},Be={class:"character-info"},Me={class:"header"},He={class:"selected"},je=["value"],Ne={class:"preview-icons"},Fe={class:"current-info"},Qe={class:"debug-info"},qe={class:"object-ifno"},De={class:"info-fields"},Ae={class:"info-fields"},Ge={class:"info-fields"},Ke={class:"note-editor"},We={class:"text-editor"},Xe={class:"btns"},ze=["disabled"],Je={key:0},Ye=["disabled"],Ze=A({__name:"EditCharacterView",setup(J){const m=_(null),c=_(!1),r=G(),I=T(()=>r.characters),n=T(()=>r.currentCharacter),V=T(()=>n.value?Object.keys(n.value):[]),p=T({get:()=>r.currentCharacterId,set:a=>{a!==null&&r.changeCurrentCharacterId(a)}}),w=_(null),y=_(null),$=_(null),E=_(null);function R(a){const e=a.target;if(!e.files||!e.files[0])return;w.value=e.files[0],console.log(w.value),r.editViewCharacterIconUrl=N(w.value,r.editViewCharacterIconUrl),console.log(r.editViewCharacterIconUrl);const i=j("characterIcons",w.value.name);$.value=n.value.icon_path,n.value.icon_path=i}function h(a){const e=a.target;if(!e.files||!e.files[0])return;y.value=e.files[0],console.log(y.value),r.editViewCharacterImageUrl=N(y.value,r.editViewCharacterImageUrl),console.log(r.editViewCharacterIconUrl);const i=j("characterFull",y.value.name);E.value=n.value.image_full_path,n.value.image_full_path=i}async function L(){if(c.value=!0,!window.confirm("Вы уверены, что хотите обновить персонажа?"))return;const e=n.value;if(!e.name){alert("НЕТ ИМЕНИ ПЕРСОНАЖА"),c.value=!1;return}console.log("UPLOADINBG CHARACTER: ",e);let i=!1;if(!e.icon_path||!e.image_full_path){alert("НЕТ ИЗОБРАЖЕНИЙ ПЕРСОНАЖА"),c.value=!1;return}e.icon_path&&($.value&&await F($.value).catch(l=>console.log(l)),await Q(e.icon_path,w.value).catch(()=>i=!0)),e.image_full_path&&(E.value&&await F(E.value).catch(l=>console.log(l)),await Q(e.image_full_path,y.value).catch(()=>i=!0)),await ae(e),c.value=!1,r.editViewCharacterIconUrl="",r.editViewCharacterImageUrl="",i&&alert("Ошибка при загрузке изображений"),alert("Информация персонажа обновлена, перезагрузите страницу"),r.changeCurrentCharacterId(e.id)}async function P(){if(c.value=!0,!window.confirm("Вы уверены, что хотите удалить персонажа?")){c.value=!1;return}await ne(n.value),c.value=!1}te(()=>{r.editViewCharacterIconUrl&&URL.revokeObjectURL(r.editViewCharacterIconUrl),r.editViewCharacterImageUrl&&URL.revokeObjectURL(r.editViewCharacterImageUrl)});const d=a=>{const e=!a||a==="<p><br></p>"||a==="<p></p>",i=e?"":a;n.value.tier_list_note=i,e&&m.value&&m.value.getQuill().setText("")};return K(()=>n.value?.id,()=>{const a=m.value?.getQuill();if(!a)return;const e=n.value?.tier_list_note||"";a.clipboard.dangerouslyPasteHTML(e)}),(a,e)=>{const i=W("QuillEditor");return n.value?(o(),u("div",Le,[S(k(le),{class:"scrollbar-root",options:{scrollbars:{autoHide:"never",theme:"os-theme-light"}}},{default:X(()=>[t("div",Pe,[t("div",Be,[t("div",Me,[t("div",He,[t("p",null,"Выбрано: "+C(n.value.name),1),b(t("select",{"onUpdate:modelValue":e[0]||(e[0]=l=>p.value=l)},[(o(!0),u(O,null,M(I.value,l=>(o(),u("option",{key:l.id,value:l.id},C(l.name),9,je))),128)),e[13]||(e[13]=t("option",{value:-1},"Новый",-1))],512),[[x,p.value]])]),t("div",Ne,[S(D,{character:n.value},null,8,["character"]),S(D,{character:n.value,squared:""},null,8,["character"])])]),t("div",Fe,[t("div",Qe,[(o(!0),u(O,null,M(V.value,l=>(o(),u("div",{key:l},C(l)+": "+C(n.value[l]),1))),128))]),t("div",qe,[t("div",De,[t("label",null,[e[14]||(e[14]=f("Имя ",-1)),b(t("input",{type:"text","onUpdate:modelValue":e[1]||(e[1]=l=>n.value.name=l)},null,512),[[U,n.value.name]])]),t("label",null,[e[16]||(e[16]=f("Редкость ",-1)),b(t("select",{"onUpdate:modelValue":e[2]||(e[2]=l=>n.value.rarity=l)},[...e[15]||(e[15]=[t("option",{value:"sr"},"sr",-1),t("option",{value:"ssr"},"ssr",-1)])],512),[[x,n.value.rarity]])]),t("label",null,[e[18]||(e[18]=f("Роль ",-1)),b(t("select",{"onUpdate:modelValue":e[3]||(e[3]=l=>n.value.role=l)},[...e[17]||(e[17]=[t("option",{value:"assault"},"assault",-1),t("option",{value:"support"},"support",-1),t("option",{value:"tactic"},"tactic",-1)])],512),[[x,n.value.role]])]),t("label",null,[e[20]||(e[20]=f("Тип урона ",-1)),b(t("select",{"onUpdate:modelValue":e[4]||(e[4]=l=>n.value.type=l)},[...e[19]||(e[19]=[t("option",{value:"slash"},"slash",-1),t("option",{value:"strike"},"strike",-1),t("option",{value:"thrust"},"thrust",-1),t("option",{value:"spirit"},"spirit",-1)])],512),[[x,n.value.type]])]),t("label",null,[e[22]||(e[22]=f("Тир ",-1)),b(t("select",{"onUpdate:modelValue":e[5]||(e[5]=l=>n.value.tier=l)},[...e[21]||(e[21]=[t("option",{value:"s"},"s",-1),t("option",{value:"a"},"a",-1),t("option",{value:"b"},"b",-1),t("option",{value:"c"},"c",-1),t("option",{value:"d"},"d",-1)])],512),[[x,n.value.tier]])])]),t("div",Ae,[t("label",null,[e[23]||(e[23]=f("АТК ",-1)),b(t("input",{type:"number","onUpdate:modelValue":e[6]||(e[6]=l=>n.value.attack=l)},null,512),[[U,n.value.attack]])]),t("label",null,[e[24]||(e[24]=f("DEF ",-1)),b(t("input",{type:"number","onUpdate:modelValue":e[7]||(e[7]=l=>n.value.defence=l)},null,512),[[U,n.value.defence]])]),t("label",null,[e[25]||(e[25]=f("HP ",-1)),b(t("input",{type:"number","onUpdate:modelValue":e[8]||(e[8]=l=>n.value.hp=l)},null,512),[[U,n.value.hp]])]),t("label",null,[e[26]||(e[26]=f("CRIT DMG % ",-1)),b(t("input",{type:"number","onUpdate:modelValue":e[9]||(e[9]=l=>n.value.crit_damage=l)},null,512),[[U,n.value.crit_damage]])]),t("label",null,[e[27]||(e[27]=f("CRIT RATE % ",-1)),b(t("input",{type:"number","onUpdate:modelValue":e[10]||(e[10]=l=>n.value.crit_rate=l)},null,512),[[U,n.value.crit_rate]])])]),t("div",Ge,[t("label",null,[e[28]||(e[28]=f("Иконка 136х160 .webp ",-1)),t("input",{type:"file",accept:"image/webp",onChange:R,multiple:"false"},null,32)]),t("label",null,[e[29]||(e[29]=f("1920х1080 арт персонажа .webp ",-1)),t("input",{type:"file",accept:"image/webp",onChange:h,multiple:"false"},null,32)]),e[31]||(e[31]=t("p",null," Для любых картинок / иконок лучше всего использовать формат .webp - он почти такой же по качесвту как png, но обычно весит в 2-3 раза меньше, что влияет на скорость загрузки страницы. Однако можно загружать и другие форматы, они просто весят больше. ",-1)),e[32]||(e[32]=t("br",null,null,-1)),t("div",Ke,[t("div",We,[e[30]||(e[30]=t("h2",null,"Заметка для тир-листа",-1)),S(i,{ref_key:"quillRef",ref:m,theme:"snow",toolbar:"full","content-type":"html",content:n.value.tier_list_note,"onUpdate:content":[e[11]||(e[11]=l=>n.value.tier_list_note=l),d]},null,8,["content"])]),t("button",{class:"del-btn",onClick:e[12]||(e[12]=l=>d(""))},"Отчистить заметку")])])])]),t("div",Xe,[t("button",{disabled:c.value,class:"save-btn",onClick:L},C(c.value?"в процессе...":"СОХРАНИТЬ ПЕРСОНАЖА"),9,ze),c.value?(o(),u("p",Je,"загрузочка...")):v("",!0),t("button",{disabled:c.value,class:"del-btn",onClick:P},C(c.value?"в процессе...":"УДАЛИТЬ ПЕРСОНАЖА"),9,Ye)])]),p.value>0?(o(),B(Re,{key:0})):v("",!0)])]),_:1})])):v("",!0)}}}),at=z(Ze,[["__scopeId","data-v-7a06391d"]]);export{at as default};
