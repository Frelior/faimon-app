import{e as G,m as K,f as W,n as x,l as _,p as X,c as o,F as T,h as p,a as l,s as B,u as I,t as b,i as P,r as Y,d as v,E as Z,G as j,H,A as M,I as N,J as F,o as s,_ as Q,K as ee,x as C,L as S,b as D,M as U,N as te,O as le,P as ae}from"./index-B8Ea0Est.js";import{s as A,c as ne,C as ie,g as se,a as oe}from"./CharacterPageView-BAiwzdr3.js";import{C as q}from"./CharacterHexagonComponent-C5vXArsb.js";const re={key:0,id:"view-head",class:"edit-skills"},ue={class:"btns"},ce=["disabled"],de={class:"block-title"},pe={class:"skills"},ve={key:0,class:"skill-title"},fe={class:"block-skill inner"},me={key:0,class:"l-name"},he=["innerHTML","onClick"],ge=["innerHTML","onClick"],Ce=["onClick"],_e={class:"block-skill-buttons"},be={key:0},ke={key:1},we={key:0},Ie={key:1},ye=["src"],Ue=["onChange"],Ve=["onClick"],$e=["onClick"],Ee=["onClick"],Se=["disabled"],xe=G({__name:"EditCharacterSkillsView",setup(J){const u=K(),r=W({attack:{title:"Базовая атака",skills:[]},technique:{title:"Техника",skills:[]},ultimate:{title:"Ульта",skills:[]},counter:{title:"Контратака",skills:[]},dodge:{title:"Уворот",skills:[]},passive:{title:"Пассивки",skills:[]},constellation:{title:"Консты",skills:[]},weapon:{title:"Оружие",skills:[]},coreStamp:{title:"Именной штамп",skills:[]},description:{title:"Описание",skills:[]}}),k=x(()=>Object.values(r).flatMap(e=>e.skills)),a=_([]),V=_([]),y=_([]),d=_(!1),w=_(0);X(()=>u.currentCharacter,async()=>{if(u.currentCharacter){const e=await se(u.currentCharacter.id);if(e)for(const t in r)r[t].skills=oe(e,t)}},{immediate:!0});function $(e,t){e.id&&a.value.push(e.id),t.splice(t.indexOf(e),1),console.log(a.value)}function E(e,t,g){if(!t||!g)return;const c=e.target;if(!c.files||!c.files[0])return;const i=c.files[0],n=j(g,i.name);console.log("new image path",n),y.value.push({file:i,path:n}),console.log(y.value),t.image_path&&V.value.push(t.image_path),t.image_path=n,t.preview_url=H(i,t?.preview_url)}function R(e){e.image_path&&V.value.push(e.image_path),e.image_path="",e.preview_url=""}async function O(){if(!window.confirm("Вы уверены, что хотите сохранить изменения скилов?"))return;let t=!1;if(d.value=!0,!k.value.length){d.value=!1,alert("НЕТ СКИЛОВ");return}k.value.forEach(i=>{Object.keys(i).includes("preview_url")&&delete i.preview_url,Object.keys(i).includes("client_id")&&delete i.client_id});const g=k.value.filter(i=>i.id),c=k.value.filter(i=>!i.id);for(const i of g){const{id:n,...h}=i,{error:z}=await M.from("skills").update(h).eq("id",n);z&&(d.value=!1,alert("Ошибка обновления скилов"),t=!0)}for(const i of c){const{error:n}=await M.from("skills").insert(i);n&&(d.value=!1,alert("Ошибка добавления скилов"),t=!0)}a.value.length&&await M.from("skills").delete().in("id",a.value).then(i=>{console.log(i.data),i.error&&(console.error(i.error),alert("Ошибка удаления скилов, но все остальные скилы обновлены"),t=!0),a.value=[]});for(const i of V.value)await N(i);for(const i of y.value)await F(i.path,i.file);t&&(d.value=!1,alert("Сохранение прошло с ошибками")),alert("Информация персонажа обновлена, перезагрузите страницу"),d.value=!1}const f=_(null);function L(e,t){f.value={skillId:e.client_id,field:t}}function m(){f.value=null}return(e,t)=>{const g=Y("QuillEditor");return s(),o(T,null,[I(u).currentCharacter?.id?(s(),o("div",re,[t[3]||(t[3]=l("h1",null,"Редактирование скилов (нажми на поле для редактирования)",-1)),l("div",ue,[l("button",{disabled:d.value,class:"save-skills",onClick:O},b(d.value?"Сохранение...":"СОХРАНИТЬ СКИЛЛЫ"),9,ce)]),(s(!0),o(T,null,P(r,(c,i)=>(s(),o("div",{class:"info-block",key:i},[l("p",de,b(c.title),1),l("div",pe,[(s(!0),o(T,null,P(c.skills,n=>(s(),o("div",{class:"block-skill",key:n.client_id},[i!=="description"?(s(),o("p",ve," Запись №"+b(c.skills.indexOf(n)+1),1)):p("",!0),l("div",fe,[i!=="description"?(s(),o("p",me,"Название")):p("",!0),i!=="description"&&!(f.value?.skillId===n.client_id&&f.value?.field==="name")?(s(),o("div",{key:1,class:"editable-text",innerHTML:n.name||"<i>Кликните для редактирования</i>",onClick:h=>L(n,"name")},null,8,he)):p("",!0),i!=="description"&&f.value?.skillId===n.client_id&&f.value?.field==="name"?(s(),B(g,{key:2,theme:"snow","content-type":"html",toolbar:"full",content:n.name,"onUpdate:content":h=>n.name=h,onBlur:m},null,8,["content","onUpdate:content"])):p("",!0),t[1]||(t[1]=l("p",{class:"l-name"},"Описание",-1)),f.value?.skillId===n.client_id&&f.value?.field==="description"?p("",!0):(s(),o("div",{key:3,class:"editable-text",innerHTML:n.description||"<i>Кликните для редактирования</i>",onClick:h=>L(n,"description")},null,8,ge)),f.value?.skillId===n.client_id&&f.value?.field==="description"?(s(),B(g,{key:4,theme:"snow","content-type":"html",toolbar:"full",content:n.description,"onUpdate:content":h=>n.description=h,onBlur:m},null,8,["content","onUpdate:content"])):p("",!0),l("button",{onClick:h=>{n.name="",n.description=""}}," clear ",8,Ce)]),l("div",_e,[l("p",null,[t[2]||(t[2]=v(" Картинка: ",-1)),i==="description"?(s(),o("span",be,"Баннер в начале страницы, в оригинале 1600х1016")):(s(),o("span",ke,"соотношение 1:1, типа 80х80 или 128х128"))]),n.image_path?(s(),o("p",we,"Загружена: "+b(n.image_path),1)):(s(),o("p",Ie,"Отсутствует")),n.image_path||n.preview_url?(s(),o("img",{key:2,src:n.preview_url||I(Z)(n.image_path)||"",class:"block-skill-image"},null,8,ye)):p("",!0),l("input",{type:"file",accept:"image/*",onChange:h=>E(h,n,"skillIcons"),multiple:"false"},null,40,Ue),n.image_path?(s(),o("button",{key:3,onClick:h=>R(n)}," Удалить картинку с сервера ",8,Ve)):p("",!0),l("button",{class:"del-btn",onClick:h=>($(n,c.skills),c.skills=I(A)(c.skills))}," УДАЛИТЬ СКИЛЛ ",8,$e)])]))),128)),i==="description"&&c.skills.length>=1?p("",!0):(s(),o("button",{key:0,class:"add-btn",onClick:n=>(c.skills.push(I(ne)(I(u).currentCharacter.id,String(i),c.skills.length+1)),c.skills=I(A)(c.skills))}," ДОБАВИТЬ СКИЛЛ В СЕКЦИЮ ",8,Ee))])]))),128))])):p("",!0),l("button",{disabled:d.value,class:"save-skills",onClick:O},b(d.value?"Сохранение...":"СОХРАНИТЬ СКИЛЛЫ"),9,Se),t[4]||(t[4]=l("p",{class:"preview-title"},"ПРЕВЬЮ",-1)),l("button",{onClick:t[0]||(t[0]=c=>w.value++)},"Обновить превью"),k.value.length&&I(u).currentCharacter?(s(),B(ie,{id:"view-preview",key:w.value,previewCharacter:I(u).currentCharacter,previewSkills:k.value},null,8,["previewCharacter","previewSkills"])):p("",!0)],64)}}}),Te=Q(xe,[["__scopeId","data-v-41a07a07"]]),Oe={key:0,class:"view-container edit-character"},Le={class:"character-info"},Be={class:"header"},Pe={class:"selected"},Re=["value"],Me={class:"preview-icons"},je={class:"current-info"},He={class:"debug-info"},Ne={class:"object-ifno"},Fe={class:"info-fields"},De={class:"info-fields"},Ae={class:"info-fields"},qe={class:"btns"},Ge=["disabled"],Ke={key:0},Qe=["disabled"],Je=G({__name:"EditCharacterView",setup(J){const u=_(!1),r=K(),k=x(()=>r.characters),a=x(()=>r.currentCharacter),V=x(()=>a.value?Object.keys(a.value):[]),y=x({get:()=>r.currentCharacterId,set:m=>{m!==null&&r.changeCurrentCharacterId(m)}}),d=_(null),w=_(null),$=_(null),E=_(null);function R(m){const e=m.target;if(!e.files||!e.files[0])return;d.value=e.files[0],console.log(d.value),r.editViewCharacterIconUrl=H(d.value,r.editViewCharacterIconUrl),console.log(r.editViewCharacterIconUrl);const t=j("characterIcons",d.value.name);$.value=a.value.icon_path,a.value.icon_path=t}function O(m){const e=m.target;if(!e.files||!e.files[0])return;w.value=e.files[0],console.log(w.value),r.editViewCharacterImageUrl=H(w.value,r.editViewCharacterImageUrl),console.log(r.editViewCharacterIconUrl);const t=j("characterFull",w.value.name);E.value=a.value.image_full_path,a.value.image_full_path=t}async function f(){if(u.value=!0,!window.confirm("Вы уверены, что хотите обновить персонажа?"))return;const e=a.value;if(!e.name){alert("НЕТ ИМЕНИ ПЕРСОНАЖА"),u.value=!1;return}console.log("UPLOADINBG CHARACTER: ",e);let t=!1;e.icon_path&&($.value&&await N($.value).catch(g=>console.log(g)),await F(e.icon_path,d.value).catch(()=>t=!0)),e.image_full_path&&(E.value&&await N(E.value).catch(g=>console.log(g)),await F(e.image_full_path,w.value).catch(()=>t=!0)),await le(e),u.value=!1,r.editViewCharacterIconUrl="",r.editViewCharacterImageUrl="",t&&alert("Ошибка загрузки изображений"),alert("Информация персонажа обновлена, перезагрузите страницу"),r.changeCurrentCharacterId(e.id)}async function L(){if(u.value=!0,!window.confirm("Вы уверены, что хотите удалить персонажа?")){u.value=!1;return}await ae(a.value),u.value=!1}return ee(()=>{r.editViewCharacterIconUrl&&URL.revokeObjectURL(r.editViewCharacterIconUrl),r.editViewCharacterImageUrl&&URL.revokeObjectURL(r.editViewCharacterImageUrl)}),(m,e)=>a.value?(s(),o("div",Oe,[l("div",Le,[l("div",Be,[l("div",Pe,[l("p",null,"Выбрано: "+b(a.value.name),1),C(l("select",{"onUpdate:modelValue":e[0]||(e[0]=t=>y.value=t)},[(s(!0),o(T,null,P(k.value,t=>(s(),o("option",{key:t.id,value:t.id},b(t.name),9,Re))),128)),e[11]||(e[11]=l("option",{value:-1},"Новый",-1))],512),[[S,y.value]])]),l("div",Me,[D(q,{character:a.value},null,8,["character"]),D(q,{character:a.value,squared:""},null,8,["character"])])]),l("div",je,[l("div",He,[(s(!0),o(T,null,P(V.value,t=>(s(),o("div",{key:t},b(t)+": "+b(a.value[t]),1))),128))]),l("div",Ne,[l("div",Fe,[l("label",null,[e[12]||(e[12]=v("Имя ",-1)),C(l("input",{type:"text","onUpdate:modelValue":e[1]||(e[1]=t=>a.value.name=t)},null,512),[[U,a.value.name]])]),l("label",null,[e[14]||(e[14]=v("Редкость ",-1)),C(l("select",{"onUpdate:modelValue":e[2]||(e[2]=t=>a.value.rarity=t)},[...e[13]||(e[13]=[l("option",{value:"sr"},"sr",-1),l("option",{value:"ssr"},"ssr",-1)])],512),[[S,a.value.rarity]])]),l("label",null,[e[16]||(e[16]=v("Роль ",-1)),C(l("select",{"onUpdate:modelValue":e[3]||(e[3]=t=>a.value.role=t)},[...e[15]||(e[15]=[l("option",{value:"assault"},"assault",-1),l("option",{value:"support"},"support",-1),l("option",{value:"tactic"},"tactic",-1)])],512),[[S,a.value.role]])]),l("label",null,[e[18]||(e[18]=v("Тип урона ",-1)),C(l("select",{"onUpdate:modelValue":e[4]||(e[4]=t=>a.value.type=t)},[...e[17]||(e[17]=[l("option",{value:"slash"},"slash",-1),l("option",{value:"strike"},"strike",-1),l("option",{value:"thrust"},"thrust",-1),l("option",{value:"spirit"},"spirit",-1)])],512),[[S,a.value.type]])]),l("label",null,[e[20]||(e[20]=v("Тир ",-1)),C(l("select",{"onUpdate:modelValue":e[5]||(e[5]=t=>a.value.tier=t)},[...e[19]||(e[19]=[te('<option value="s" data-v-b4c8d151>s</option><option value="a" data-v-b4c8d151>a</option><option value="b" data-v-b4c8d151>b</option><option value="c" data-v-b4c8d151>c</option><option value="d" data-v-b4c8d151>d</option>',5)])],512),[[S,a.value.tier]])])]),l("div",De,[l("label",null,[e[21]||(e[21]=v("АТК ",-1)),C(l("input",{type:"number","onUpdate:modelValue":e[6]||(e[6]=t=>a.value.attack=t)},null,512),[[U,a.value.attack]])]),l("label",null,[e[22]||(e[22]=v("DEF ",-1)),C(l("input",{type:"number","onUpdate:modelValue":e[7]||(e[7]=t=>a.value.defence=t)},null,512),[[U,a.value.defence]])]),l("label",null,[e[23]||(e[23]=v("HP ",-1)),C(l("input",{type:"number","onUpdate:modelValue":e[8]||(e[8]=t=>a.value.hp=t)},null,512),[[U,a.value.hp]])]),l("label",null,[e[24]||(e[24]=v("CRIT DMG % ",-1)),C(l("input",{type:"number","onUpdate:modelValue":e[9]||(e[9]=t=>a.value.crit_damage=t)},null,512),[[U,a.value.crit_damage]])]),l("label",null,[e[25]||(e[25]=v("CRIT RATE % ",-1)),C(l("input",{type:"number","onUpdate:modelValue":e[10]||(e[10]=t=>a.value.crit_rate=t)},null,512),[[U,a.value.crit_rate]])])]),l("div",Ae,[l("label",null,[e[26]||(e[26]=v("Иконка 136х160 .png ",-1)),l("input",{type:"file",accept:"image/png",onChange:R,multiple:"false"},null,32)]),l("label",null,[e[27]||(e[27]=v("1920х1080 арт персонажа .png ",-1)),l("input",{type:"file",accept:"image/png",onChange:O,multiple:"false"},null,32)])])])]),l("div",qe,[l("button",{disabled:u.value,class:"btn save",onClick:f},b(u.value?"в процессе...":"СОХРАНИТЬ ПЕРСОНАЖА"),9,Ge),u.value?(s(),o("p",Ke,"загрузочка...")):p("",!0),l("button",{disabled:u.value,class:"btn delete",onClick:L},b(u.value?"в процессе...":"УДАЛИТЬ ПЕРСОНАЖА"),9,Qe)])]),y.value>0?(s(),B(Te,{key:0})):p("",!0)])):p("",!0)}}),Ye=Q(Je,[["__scopeId","data-v-b4c8d151"]]);export{Ye as default};
