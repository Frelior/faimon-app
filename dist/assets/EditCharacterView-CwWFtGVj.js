import{e as q,l as G,f as z,m as E,k as g,B as W,c as d,F as S,h as m,a as t,p as O,u as I,t as k,i as R,r as X,d as p,C as P,D as j,x as M,E as H,G as F,o as s,_ as K,H as Y,s as h,I as $,b as N,J as y,K as Z,L as ee,M as te}from"./index-B6ioe6PY.js";import{s as D,c as le,C as ae,g as ne,a as ie}from"./CharacterPageView-B1iFtFQw.js";import{C as A}from"./CharacterHexagonComponent-DaRh6Z__.js";const se={key:0,id:"view-head",class:"edit-skills"},oe={class:"btns"},re=["disabled"],ue={class:"block-title"},de={class:"skills"},ce={key:0,class:"skill-title"},ve={class:"block-skill inner"},pe={key:0,class:"l-name"},fe=["innerHTML","onClick"],me=["innerHTML","onClick"],he={class:"block-skill-buttons"},ge={key:0},ke={key:1},Ce={key:0},be={key:1},_e=["onChange"],we=["onClick"],Ie=["onClick"],ye=["disabled"],Ue=q({__name:"EditCharacterSkillsView",setup(Q){const c=G(),r=z({attack:{title:"Базовая атака",skills:[]},technique:{title:"Техника",skills:[]},ultimate:{title:"Ульта",skills:[]},counter:{title:"Контратака",skills:[]},dodge:{title:"Уворот",skills:[]},passive:{title:"Пассивки",skills:[]},constellation:{title:"Консты",skills:[]},weapon:{title:"Оружие",skills:[]},coreStamp:{title:"Именной штамп",skills:[]},description:{title:"Описание",skills:[]}}),b=E(()=>Object.values(r).flatMap(o=>o.skills)),a=g([]),x=g([]),w=g([]),v=g(!1),_=g(0);W(()=>c.currentCharacter,async()=>{if(c.currentCharacter){const o=await ne(c.currentCharacter.id);if(o)for(const e in r)r[e].skills=ie(o,e)}},{immediate:!0});function U(o,e){o.id&&a.value.push(o.id),e.splice(e.indexOf(o),1),console.log(a.value)}function V(o,e,l){if(!e||!l)return;const u=o.target;if(!u.files||!u.files[0])return;const n=u.files[0],i=P(l,n.name);console.log("new image path",i),w.value.push({file:n,path:i}),console.log(w.value),e.image_path&&x.value.push(e.image_path),e.image_path=i,e.preview_url=j(n,e?.preview_url)}async function T(){if(!window.confirm("Вы уверены, что хотите сохранить изменения скилов?"))return;let e=!1;if(v.value=!0,!b.value.length){v.value=!1,alert("НЕТ СКИЛОВ");return}b.value.forEach(n=>{Object.keys(n).includes("preview_url")&&delete n.preview_url,Object.keys(n).includes("client_id")&&delete n.client_id});const l=b.value.filter(n=>n.id),u=b.value.filter(n=>!n.id);for(const n of l){const{id:i,...C}=n,{error:J}=await M.from("skills").update(C).eq("id",i);J&&(v.value=!1,alert("Ошибка обновления скилов"),e=!0)}for(const n of u){const{error:i}=await M.from("skills").insert(n);i&&(v.value=!1,alert("Ошибка добавления скилов"),e=!0)}a.value.length&&await M.from("skills").delete().in("id",a.value).then(n=>{console.log(n.data),n.error&&(console.error(n.error),alert("Ошибка удаления скилов, но все остальные скилы обновлены"),e=!0),a.value=[]});for(const n of x.value)await H(n);for(const n of w.value)await F(n.path,n.file);e&&(v.value=!1,alert("Сохранение прошло с ошибками")),alert("Информация персонажа обновлена, перезагрузите страницу"),v.value=!1}const f=g(null);function B(o,e){f.value={skillId:o.client_id,field:e}}function L(){f.value=null}return(o,e)=>{const l=X("QuillEditor");return s(),d(S,null,[I(c).currentCharacter?.id?(s(),d("div",se,[e[3]||(e[3]=t("h1",null,"Редактирование скилов (нажми на поле для редактирования)",-1)),t("div",oe,[t("button",{disabled:v.value,class:"save-skills",onClick:T},k(v.value?"Сохранение...":"СОХРАНИТЬ СКИЛЛЫ"),9,re)]),(s(!0),d(S,null,R(r,(u,n)=>(s(),d("div",{class:"info-block",key:n},[t("p",ue,k(u.title),1),t("div",de,[(s(!0),d(S,null,R(u.skills,i=>(s(),d("div",{class:"block-skill",key:i.client_id},[n!=="description"?(s(),d("p",ce," Запись №"+k(u.skills.indexOf(i)+1),1)):m("",!0),t("div",ve,[n!=="description"?(s(),d("p",pe,"Название")):m("",!0),n!=="description"&&!(f.value?.skillId===i.client_id&&f.value?.field==="name")?(s(),d("div",{key:1,class:"editable-text",innerHTML:i.name||"<i>Кликните для редактирования</i>",onClick:C=>B(i,"name")},null,8,fe)):m("",!0),n!=="description"&&f.value?.skillId===i.client_id&&f.value?.field==="name"?(s(),O(l,{key:2,theme:"snow","content-type":"html",toolbar:["bold","italic","underline",{header:1},{header:2},{color:[]},{background:[]},"link"],content:i.name,"onUpdate:content":C=>i.name=C,onBlur:L},null,8,["content","onUpdate:content"])):m("",!0),e[1]||(e[1]=t("p",{class:"l-name"},"Описание",-1)),f.value?.skillId===i.client_id&&f.value?.field==="description"?m("",!0):(s(),d("div",{key:3,class:"editable-text",innerHTML:i.description||"<i>Кликните для редактирования</i>",onClick:C=>B(i,"description")},null,8,me)),f.value?.skillId===i.client_id&&f.value?.field==="description"?(s(),O(l,{key:4,theme:"snow","content-type":"html",toolbar:["bold","italic","underline",{header:1},{header:2},{color:[]},{background:[]},"link"],content:i.description,"onUpdate:content":C=>i.description=C,onBlur:L},null,8,["content","onUpdate:content"])):m("",!0)]),t("div",he,[t("p",null,[e[2]||(e[2]=p(" Картинка: ",-1)),n==="description"?(s(),d("span",ge,"Баннер в начале страницы, в оригинале 1600х1016")):(s(),d("span",ke,"соотношение 1:1, типа 80х80 или 128х128"))]),i.image_path?(s(),d("p",Ce,"Загружена: "+k(i.image_path),1)):(s(),d("p",be,"Отсутствует")),t("input",{type:"file",accept:"image/*",onChange:C=>V(C,i,"skillIcons"),multiple:"false"},null,40,_e),t("button",{class:"del-btn",onClick:C=>(U(i,u.skills),u.skills=I(D)(u.skills))}," УДАЛИТЬ СКИЛЛ ",8,we)])]))),128)),n==="description"&&u.skills.length>=1?m("",!0):(s(),d("button",{key:0,class:"add-btn",onClick:i=>(u.skills.push(I(le)(I(c).currentCharacter.id,String(n),u.skills.length+1)),u.skills=I(D)(u.skills))}," ДОБАВИТЬ СКИЛЛ В СЕКЦИЮ ",8,Ie))])]))),128))])):m("",!0),t("button",{disabled:v.value,class:"save-skills",onClick:T},k(v.value?"Сохранение...":"СОХРАНИТЬ СКИЛЛЫ"),9,ye),e[4]||(e[4]=t("p",{class:"preview-title"},"ПРЕВЬЮ",-1)),t("button",{onClick:e[0]||(e[0]=u=>_.value++)},"Обновить превью"),b.value.length&&I(c).currentCharacter?(s(),O(ae,{id:"view-preview",key:_.value,previewCharacter:I(c).currentCharacter,previewSkills:b.value},null,8,["previewCharacter","previewSkills"])):m("",!0)],64)}}}),Ve=K(Ue,[["__scopeId","data-v-8b1db945"]]),$e={key:0,class:"view-container edit-character"},Ee={class:"character-info"},Se={class:"header"},xe={class:"selected"},Te=["value"],Be={class:"preview-icons"},Le={class:"current-info"},Oe={class:"debug-info"},Re={class:"object-ifno"},Me={class:"info-fields"},Pe={class:"info-fields"},je={class:"info-fields"},He={class:"btns"},Fe=["disabled"],Ne={key:0},De=["disabled"],Ae=q({__name:"EditCharacterView",setup(Q){const c=g(!1),r=G(),b=E(()=>r.characters),a=E(()=>r.currentCharacter),x=E(()=>a.value?Object.keys(a.value):[]),w=E({get:()=>r.currentCharacterId,set:o=>{o!==null&&r.changeCurrentCharacterId(o)}}),v=g(null),_=g(null),U=g(null),V=g(null);function T(o){const e=o.target;if(!e.files||!e.files[0])return;v.value=e.files[0],console.log(v.value),r.editViewCharacterIconUrl=j(v.value,r.editViewCharacterIconUrl),console.log(r.editViewCharacterIconUrl);const l=P("characterIcons",v.value.name);U.value=a.value.icon_path,a.value.icon_path=l}function f(o){const e=o.target;if(!e.files||!e.files[0])return;_.value=e.files[0],console.log(_.value),r.editViewCharacterImageUrl=j(_.value,r.editViewCharacterImageUrl),console.log(r.editViewCharacterIconUrl);const l=P("characterFull",_.value.name);V.value=a.value.image_full_path,a.value.image_full_path=l}async function B(){if(c.value=!0,!window.confirm("Вы уверены, что хотите обновить персонажа?"))return;const e=a.value;if(!e.name){alert("НЕТ ИМЕНИ ПЕРСОНАЖА"),c.value=!1;return}console.log("UPLOADINBG CHARACTER: ",e);let l=!1;e.icon_path&&(U.value&&await H(U.value).catch(u=>console.log(u)),await F(e.icon_path,v.value).catch(()=>l=!0)),e.image_full_path&&(V.value&&await H(V.value).catch(u=>console.log(u)),await F(e.image_full_path,_.value).catch(()=>l=!0)),await ee(e),c.value=!1,r.editViewCharacterIconUrl="",r.editViewCharacterImageUrl="",l&&alert("Ошибка загрузки изображений"),alert("Информация персонажа обновлена, перезагрузите страницу"),r.changeCurrentCharacterId(e.id)}async function L(){if(c.value=!0,!window.confirm("Вы уверены, что хотите удалить персонажа?")){c.value=!1;return}await te(a.value),c.value=!1}return Y(()=>{r.editViewCharacterIconUrl&&URL.revokeObjectURL(r.editViewCharacterIconUrl),r.editViewCharacterImageUrl&&URL.revokeObjectURL(r.editViewCharacterImageUrl)}),(o,e)=>a.value?(s(),d("div",$e,[t("div",Ee,[t("div",Se,[t("div",xe,[t("p",null,"Выбрано: "+k(a.value.name),1),h(t("select",{"onUpdate:modelValue":e[0]||(e[0]=l=>w.value=l)},[(s(!0),d(S,null,R(b.value,l=>(s(),d("option",{key:l.id,value:l.id},k(l.name),9,Te))),128)),e[11]||(e[11]=t("option",{value:-1},"Новый",-1))],512),[[$,w.value]])]),t("div",Be,[N(A,{character:a.value},null,8,["character"]),N(A,{character:a.value,squared:""},null,8,["character"])])]),t("div",Le,[t("div",Oe,[(s(!0),d(S,null,R(x.value,l=>(s(),d("div",{key:l},k(l)+": "+k(a.value[l]),1))),128))]),t("div",Re,[t("div",Me,[t("label",null,[e[12]||(e[12]=p("Имя ",-1)),h(t("input",{type:"text","onUpdate:modelValue":e[1]||(e[1]=l=>a.value.name=l)},null,512),[[y,a.value.name]])]),t("label",null,[e[14]||(e[14]=p("Редкость ",-1)),h(t("select",{"onUpdate:modelValue":e[2]||(e[2]=l=>a.value.rarity=l)},[...e[13]||(e[13]=[t("option",{value:"sr"},"sr",-1),t("option",{value:"ssr"},"ssr",-1)])],512),[[$,a.value.rarity]])]),t("label",null,[e[16]||(e[16]=p("Роль ",-1)),h(t("select",{"onUpdate:modelValue":e[3]||(e[3]=l=>a.value.role=l)},[...e[15]||(e[15]=[t("option",{value:"assault"},"assault",-1),t("option",{value:"support"},"support",-1),t("option",{value:"tactic"},"tactic",-1)])],512),[[$,a.value.role]])]),t("label",null,[e[18]||(e[18]=p("Тип урона ",-1)),h(t("select",{"onUpdate:modelValue":e[4]||(e[4]=l=>a.value.type=l)},[...e[17]||(e[17]=[t("option",{value:"slash"},"slash",-1),t("option",{value:"strike"},"strike",-1),t("option",{value:"thrust"},"thrust",-1),t("option",{value:"spirit"},"spirit",-1)])],512),[[$,a.value.type]])]),t("label",null,[e[20]||(e[20]=p("Тир ",-1)),h(t("select",{"onUpdate:modelValue":e[5]||(e[5]=l=>a.value.tier=l)},[...e[19]||(e[19]=[Z('<option value="s" data-v-b4c8d151>s</option><option value="a" data-v-b4c8d151>a</option><option value="b" data-v-b4c8d151>b</option><option value="c" data-v-b4c8d151>c</option><option value="d" data-v-b4c8d151>d</option>',5)])],512),[[$,a.value.tier]])])]),t("div",Pe,[t("label",null,[e[21]||(e[21]=p("АТК ",-1)),h(t("input",{type:"number","onUpdate:modelValue":e[6]||(e[6]=l=>a.value.attack=l)},null,512),[[y,a.value.attack]])]),t("label",null,[e[22]||(e[22]=p("DEF ",-1)),h(t("input",{type:"number","onUpdate:modelValue":e[7]||(e[7]=l=>a.value.defence=l)},null,512),[[y,a.value.defence]])]),t("label",null,[e[23]||(e[23]=p("HP ",-1)),h(t("input",{type:"number","onUpdate:modelValue":e[8]||(e[8]=l=>a.value.hp=l)},null,512),[[y,a.value.hp]])]),t("label",null,[e[24]||(e[24]=p("CRIT DMG % ",-1)),h(t("input",{type:"number","onUpdate:modelValue":e[9]||(e[9]=l=>a.value.crit_damage=l)},null,512),[[y,a.value.crit_damage]])]),t("label",null,[e[25]||(e[25]=p("CRIT RATE % ",-1)),h(t("input",{type:"number","onUpdate:modelValue":e[10]||(e[10]=l=>a.value.crit_rate=l)},null,512),[[y,a.value.crit_rate]])])]),t("div",je,[t("label",null,[e[26]||(e[26]=p("Иконка 136х160 .png ",-1)),t("input",{type:"file",accept:"image/png",onChange:T,multiple:"false"},null,32)]),t("label",null,[e[27]||(e[27]=p("1920х1080 арт персонажа .png ",-1)),t("input",{type:"file",accept:"image/png",onChange:f,multiple:"false"},null,32)])])])]),t("div",He,[t("button",{disabled:c.value,class:"btn save",onClick:B},k(c.value?"в процессе...":"СОХРАНИТЬ ПЕРСОНАЖА"),9,Fe),c.value?(s(),d("p",Ne,"загрузочка...")):m("",!0),t("button",{disabled:c.value,class:"btn delete",onClick:L},k(c.value?"в процессе...":"УДАЛИТЬ ПЕРСОНАЖА"),9,De)])]),w.value>0?(s(),O(Ve,{key:0})):m("",!0)])):m("",!0)}}),Qe=K(Ae,[["__scopeId","data-v-b4c8d151"]]);export{Qe as default};
