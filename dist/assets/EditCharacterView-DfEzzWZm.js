import{e as G,l as K,f as W,m as T,k as _,C as X,c as o,F as x,h as p,a as l,p as B,u as I,t as b,i as R,r as Y,d as v,D as Z,E as j,G as H,y as P,H as N,I as D,o as s,_ as Q,J as ee,s as C,K as S,b as F,L as U,M as te,N as le,O as ae}from"./index-Bu5F_Gl5.js";import{s as A,c as ne,C as ie,g as se,a as oe}from"./CharacterPageView-BQkdPAdY.js";import{C as q}from"./CharacterHexagonComponent-B6udd3Xw.js";const re={key:0,id:"view-head",class:"edit-skills"},ue={class:"btns"},de=["disabled"],ce={class:"block-title"},pe={class:"skills"},ve={key:0,class:"skill-title"},fe={class:"block-skill inner"},me={key:0,class:"l-name"},he=["innerHTML","onClick"],ge=["innerHTML","onClick"],Ce={class:"block-skill-buttons"},_e={key:0},be={key:1},ke={key:0},we={key:1},Ie=["src"],ye=["onChange"],Ue=["onClick"],Ve=["onClick"],$e=["onClick"],Ee=["disabled"],Se=G({__name:"EditCharacterSkillsView",setup(J){const u=K(),r=W({attack:{title:"Базовая атака",skills:[]},technique:{title:"Техника",skills:[]},ultimate:{title:"Ульта",skills:[]},counter:{title:"Контратака",skills:[]},dodge:{title:"Уворот",skills:[]},passive:{title:"Пассивки",skills:[]},constellation:{title:"Консты",skills:[]},weapon:{title:"Оружие",skills:[]},coreStamp:{title:"Именной штамп",skills:[]},description:{title:"Описание",skills:[]}}),k=T(()=>Object.values(r).flatMap(e=>e.skills)),a=_([]),V=_([]),y=_([]),c=_(!1),w=_(0);X(()=>u.currentCharacter,async()=>{if(u.currentCharacter){const e=await se(u.currentCharacter.id);if(e)for(const t in r)r[t].skills=oe(e,t)}},{immediate:!0});function $(e,t){e.id&&a.value.push(e.id),t.splice(t.indexOf(e),1),console.log(a.value)}function E(e,t,h){if(!t||!h)return;const d=e.target;if(!d.files||!d.files[0])return;const n=d.files[0],i=j(h,n.name);console.log("new image path",i),y.value.push({file:n,path:i}),console.log(y.value),t.image_path&&V.value.push(t.image_path),t.image_path=i,t.preview_url=H(n,t?.preview_url)}function M(e){e.image_path&&V.value.push(e.image_path),e.image_path="",e.preview_url=""}async function O(){if(!window.confirm("Вы уверены, что хотите сохранить изменения скилов?"))return;let t=!1;if(c.value=!0,!k.value.length){c.value=!1,alert("НЕТ СКИЛОВ");return}k.value.forEach(n=>{Object.keys(n).includes("preview_url")&&delete n.preview_url,Object.keys(n).includes("client_id")&&delete n.client_id});const h=k.value.filter(n=>n.id),d=k.value.filter(n=>!n.id);for(const n of h){const{id:i,...g}=n,{error:z}=await P.from("skills").update(g).eq("id",i);z&&(c.value=!1,alert("Ошибка обновления скилов"),t=!0)}for(const n of d){const{error:i}=await P.from("skills").insert(n);i&&(c.value=!1,alert("Ошибка добавления скилов"),t=!0)}a.value.length&&await P.from("skills").delete().in("id",a.value).then(n=>{console.log(n.data),n.error&&(console.error(n.error),alert("Ошибка удаления скилов, но все остальные скилы обновлены"),t=!0),a.value=[]});for(const n of V.value)await N(n);for(const n of y.value)await D(n.path,n.file);t&&(c.value=!1,alert("Сохранение прошло с ошибками")),alert("Информация персонажа обновлена, перезагрузите страницу"),c.value=!1}const f=_(null);function L(e,t){f.value={skillId:e.client_id,field:t}}function m(){f.value=null}return(e,t)=>{const h=Y("QuillEditor");return s(),o(x,null,[I(u).currentCharacter?.id?(s(),o("div",re,[t[3]||(t[3]=l("h1",null,"Редактирование скилов (нажми на поле для редактирования)",-1)),l("div",ue,[l("button",{disabled:c.value,class:"save-skills",onClick:O},b(c.value?"Сохранение...":"СОХРАНИТЬ СКИЛЛЫ"),9,de)]),(s(!0),o(x,null,R(r,(d,n)=>(s(),o("div",{class:"info-block",key:n},[l("p",ce,b(d.title),1),l("div",pe,[(s(!0),o(x,null,R(d.skills,i=>(s(),o("div",{class:"block-skill",key:i.client_id},[n!=="description"?(s(),o("p",ve," Запись №"+b(d.skills.indexOf(i)+1),1)):p("",!0),l("div",fe,[n!=="description"?(s(),o("p",me,"Название")):p("",!0),n!=="description"&&!(f.value?.skillId===i.client_id&&f.value?.field==="name")?(s(),o("div",{key:1,class:"editable-text",innerHTML:i.name||"<i>Кликните для редактирования</i>",onClick:g=>L(i,"name")},null,8,he)):p("",!0),n!=="description"&&f.value?.skillId===i.client_id&&f.value?.field==="name"?(s(),B(h,{key:2,theme:"snow","content-type":"html",toolbar:["bold","italic","underline",{header:1},{header:2},{color:[]},{background:[]},"link"],content:i.name,"onUpdate:content":g=>i.name=g,onBlur:m},null,8,["content","onUpdate:content"])):p("",!0),t[1]||(t[1]=l("p",{class:"l-name"},"Описание",-1)),f.value?.skillId===i.client_id&&f.value?.field==="description"?p("",!0):(s(),o("div",{key:3,class:"editable-text",innerHTML:i.description||"<i>Кликните для редактирования</i>",onClick:g=>L(i,"description")},null,8,ge)),f.value?.skillId===i.client_id&&f.value?.field==="description"?(s(),B(h,{key:4,theme:"snow","content-type":"html",toolbar:["bold","italic","underline",{header:1},{header:2},{color:[]},{background:[]},"link"],content:i.description,"onUpdate:content":g=>i.description=g,onBlur:m},null,8,["content","onUpdate:content"])):p("",!0)]),l("div",Ce,[l("p",null,[t[2]||(t[2]=v(" Картинка: ",-1)),n==="description"?(s(),o("span",_e,"Баннер в начале страницы, в оригинале 1600х1016")):(s(),o("span",be,"соотношение 1:1, типа 80х80 или 128х128"))]),i.image_path?(s(),o("p",ke,"Загружена: "+b(i.image_path),1)):(s(),o("p",we,"Отсутствует")),i.image_path||i.preview_url?(s(),o("img",{key:2,src:i.preview_url||I(Z)(i.image_path)||"",class:"block-skill-image"},null,8,Ie)):p("",!0),l("input",{type:"file",accept:"image/*",onChange:g=>E(g,i,"skillIcons"),multiple:"false"},null,40,ye),i.image_path?(s(),o("button",{key:3,onClick:g=>M(i)}," Удалить картинку с сервера ",8,Ue)):p("",!0),l("button",{class:"del-btn",onClick:g=>($(i,d.skills),d.skills=I(A)(d.skills))}," УДАЛИТЬ СКИЛЛ ",8,Ve)])]))),128)),n==="description"&&d.skills.length>=1?p("",!0):(s(),o("button",{key:0,class:"add-btn",onClick:i=>(d.skills.push(I(ne)(I(u).currentCharacter.id,String(n),d.skills.length+1)),d.skills=I(A)(d.skills))}," ДОБАВИТЬ СКИЛЛ В СЕКЦИЮ ",8,$e))])]))),128))])):p("",!0),l("button",{disabled:c.value,class:"save-skills",onClick:O},b(c.value?"Сохранение...":"СОХРАНИТЬ СКИЛЛЫ"),9,Ee),t[4]||(t[4]=l("p",{class:"preview-title"},"ПРЕВЬЮ",-1)),l("button",{onClick:t[0]||(t[0]=d=>w.value++)},"Обновить превью"),k.value.length&&I(u).currentCharacter?(s(),B(ie,{id:"view-preview",key:w.value,previewCharacter:I(u).currentCharacter,previewSkills:k.value},null,8,["previewCharacter","previewSkills"])):p("",!0)],64)}}}),Te=Q(Se,[["__scopeId","data-v-2be8a2fc"]]),xe={key:0,class:"view-container edit-character"},Oe={class:"character-info"},Le={class:"header"},Be={class:"selected"},Re=["value"],Me={class:"preview-icons"},Pe={class:"current-info"},je={class:"debug-info"},He={class:"object-ifno"},Ne={class:"info-fields"},De={class:"info-fields"},Fe={class:"info-fields"},Ae={class:"btns"},qe=["disabled"],Ge={key:0},Ke=["disabled"],Qe=G({__name:"EditCharacterView",setup(J){const u=_(!1),r=K(),k=T(()=>r.characters),a=T(()=>r.currentCharacter),V=T(()=>a.value?Object.keys(a.value):[]),y=T({get:()=>r.currentCharacterId,set:m=>{m!==null&&r.changeCurrentCharacterId(m)}}),c=_(null),w=_(null),$=_(null),E=_(null);function M(m){const e=m.target;if(!e.files||!e.files[0])return;c.value=e.files[0],console.log(c.value),r.editViewCharacterIconUrl=H(c.value,r.editViewCharacterIconUrl),console.log(r.editViewCharacterIconUrl);const t=j("characterIcons",c.value.name);$.value=a.value.icon_path,a.value.icon_path=t}function O(m){const e=m.target;if(!e.files||!e.files[0])return;w.value=e.files[0],console.log(w.value),r.editViewCharacterImageUrl=H(w.value,r.editViewCharacterImageUrl),console.log(r.editViewCharacterIconUrl);const t=j("characterFull",w.value.name);E.value=a.value.image_full_path,a.value.image_full_path=t}async function f(){if(u.value=!0,!window.confirm("Вы уверены, что хотите обновить персонажа?"))return;const e=a.value;if(!e.name){alert("НЕТ ИМЕНИ ПЕРСОНАЖА"),u.value=!1;return}console.log("UPLOADINBG CHARACTER: ",e);let t=!1;e.icon_path&&($.value&&await N($.value).catch(h=>console.log(h)),await D(e.icon_path,c.value).catch(()=>t=!0)),e.image_full_path&&(E.value&&await N(E.value).catch(h=>console.log(h)),await D(e.image_full_path,w.value).catch(()=>t=!0)),await le(e),u.value=!1,r.editViewCharacterIconUrl="",r.editViewCharacterImageUrl="",t&&alert("Ошибка загрузки изображений"),alert("Информация персонажа обновлена, перезагрузите страницу"),r.changeCurrentCharacterId(e.id)}async function L(){if(u.value=!0,!window.confirm("Вы уверены, что хотите удалить персонажа?")){u.value=!1;return}await ae(a.value),u.value=!1}return ee(()=>{r.editViewCharacterIconUrl&&URL.revokeObjectURL(r.editViewCharacterIconUrl),r.editViewCharacterImageUrl&&URL.revokeObjectURL(r.editViewCharacterImageUrl)}),(m,e)=>a.value?(s(),o("div",xe,[l("div",Oe,[l("div",Le,[l("div",Be,[l("p",null,"Выбрано: "+b(a.value.name),1),C(l("select",{"onUpdate:modelValue":e[0]||(e[0]=t=>y.value=t)},[(s(!0),o(x,null,R(k.value,t=>(s(),o("option",{key:t.id,value:t.id},b(t.name),9,Re))),128)),e[11]||(e[11]=l("option",{value:-1},"Новый",-1))],512),[[S,y.value]])]),l("div",Me,[F(q,{character:a.value},null,8,["character"]),F(q,{character:a.value,squared:""},null,8,["character"])])]),l("div",Pe,[l("div",je,[(s(!0),o(x,null,R(V.value,t=>(s(),o("div",{key:t},b(t)+": "+b(a.value[t]),1))),128))]),l("div",He,[l("div",Ne,[l("label",null,[e[12]||(e[12]=v("Имя ",-1)),C(l("input",{type:"text","onUpdate:modelValue":e[1]||(e[1]=t=>a.value.name=t)},null,512),[[U,a.value.name]])]),l("label",null,[e[14]||(e[14]=v("Редкость ",-1)),C(l("select",{"onUpdate:modelValue":e[2]||(e[2]=t=>a.value.rarity=t)},[...e[13]||(e[13]=[l("option",{value:"sr"},"sr",-1),l("option",{value:"ssr"},"ssr",-1)])],512),[[S,a.value.rarity]])]),l("label",null,[e[16]||(e[16]=v("Роль ",-1)),C(l("select",{"onUpdate:modelValue":e[3]||(e[3]=t=>a.value.role=t)},[...e[15]||(e[15]=[l("option",{value:"assault"},"assault",-1),l("option",{value:"support"},"support",-1),l("option",{value:"tactic"},"tactic",-1)])],512),[[S,a.value.role]])]),l("label",null,[e[18]||(e[18]=v("Тип урона ",-1)),C(l("select",{"onUpdate:modelValue":e[4]||(e[4]=t=>a.value.type=t)},[...e[17]||(e[17]=[l("option",{value:"slash"},"slash",-1),l("option",{value:"strike"},"strike",-1),l("option",{value:"thrust"},"thrust",-1),l("option",{value:"spirit"},"spirit",-1)])],512),[[S,a.value.type]])]),l("label",null,[e[20]||(e[20]=v("Тир ",-1)),C(l("select",{"onUpdate:modelValue":e[5]||(e[5]=t=>a.value.tier=t)},[...e[19]||(e[19]=[te('<option value="s" data-v-b4c8d151>s</option><option value="a" data-v-b4c8d151>a</option><option value="b" data-v-b4c8d151>b</option><option value="c" data-v-b4c8d151>c</option><option value="d" data-v-b4c8d151>d</option>',5)])],512),[[S,a.value.tier]])])]),l("div",De,[l("label",null,[e[21]||(e[21]=v("АТК ",-1)),C(l("input",{type:"number","onUpdate:modelValue":e[6]||(e[6]=t=>a.value.attack=t)},null,512),[[U,a.value.attack]])]),l("label",null,[e[22]||(e[22]=v("DEF ",-1)),C(l("input",{type:"number","onUpdate:modelValue":e[7]||(e[7]=t=>a.value.defence=t)},null,512),[[U,a.value.defence]])]),l("label",null,[e[23]||(e[23]=v("HP ",-1)),C(l("input",{type:"number","onUpdate:modelValue":e[8]||(e[8]=t=>a.value.hp=t)},null,512),[[U,a.value.hp]])]),l("label",null,[e[24]||(e[24]=v("CRIT DMG % ",-1)),C(l("input",{type:"number","onUpdate:modelValue":e[9]||(e[9]=t=>a.value.crit_damage=t)},null,512),[[U,a.value.crit_damage]])]),l("label",null,[e[25]||(e[25]=v("CRIT RATE % ",-1)),C(l("input",{type:"number","onUpdate:modelValue":e[10]||(e[10]=t=>a.value.crit_rate=t)},null,512),[[U,a.value.crit_rate]])])]),l("div",Fe,[l("label",null,[e[26]||(e[26]=v("Иконка 136х160 .png ",-1)),l("input",{type:"file",accept:"image/png",onChange:M,multiple:"false"},null,32)]),l("label",null,[e[27]||(e[27]=v("1920х1080 арт персонажа .png ",-1)),l("input",{type:"file",accept:"image/png",onChange:O,multiple:"false"},null,32)])])])]),l("div",Ae,[l("button",{disabled:u.value,class:"btn save",onClick:f},b(u.value?"в процессе...":"СОХРАНИТЬ ПЕРСОНАЖА"),9,qe),u.value?(s(),o("p",Ge,"загрузочка...")):p("",!0),l("button",{disabled:u.value,class:"btn delete",onClick:L},b(u.value?"в процессе...":"УДАЛИТЬ ПЕРСОНАЖА"),9,Ke)])]),y.value>0?(s(),B(Te,{key:0})):p("",!0)])):p("",!0)}}),Xe=Q(Qe,[["__scopeId","data-v-b4c8d151"]]);export{Xe as default};
